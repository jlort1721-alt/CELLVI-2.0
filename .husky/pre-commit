#!/usr/bin/env sh

# =====================================================
# Pre-commit Security Hook
# Prevents committing files with secrets or sensitive data
# =====================================================

echo "üîí Running security checks..."

# Check for .env files being staged (except .env.example)
STAGED_ENV_FILES=$(git diff --cached --name-only | grep -E '^\.env$|^\.env\.local$|^\.env\.production$|^\.env\.staging$' || true)

if [ -n "$STAGED_ENV_FILES" ]; then
  echo "‚ùå BLOCKED: Attempting to commit .env file(s):"
  echo "$STAGED_ENV_FILES"
  echo ""
  echo "Environment files contain secrets and must NOT be committed."
  echo "Use .env.example for templates and Supabase secrets for production keys."
  echo ""
  echo "To unstage: git reset HEAD <file>"
  exit 1
fi

# Check for common secret patterns in staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|yaml|yml|toml)$' || true)

if [ -n "$STAGED_FILES" ]; then
  # Check for API keys in staged content
  SECRET_PATTERNS="sk-ant-api|sk-proj-|sk-[a-zA-Z0-9]{20,}|AKIA[0-9A-Z]{16}|ghp_[a-zA-Z0-9]{36}|glpat-[a-zA-Z0-9-]{20}"

  SECRETS_FOUND=$(git diff --cached -U0 $STAGED_FILES | grep -E "^\+" | grep -v "^\+\+\+" | grep -iE "$SECRET_PATTERNS" || true)

  if [ -n "$SECRETS_FOUND" ]; then
    echo "‚ùå BLOCKED: Potential secrets detected in staged files:"
    echo "$SECRETS_FOUND"
    echo ""
    echo "API keys and secrets must NEVER be committed to the repository."
    echo "Store them in Supabase Edge Function secrets or environment variables."
    echo ""
    echo "If this is a false positive, use: git commit --no-verify"
    exit 1
  fi
fi

echo "‚úÖ Security checks passed"
